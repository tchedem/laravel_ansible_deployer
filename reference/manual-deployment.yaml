#!/bin/bash
set -e

# Variables - change these for your app
APP_NAME="laravel_app"
APP_DIR="/var/www/$APP_NAME"
REPO_URL="https://github.com/tchedem/simple-laravel-api-with-performance.git"
BRANCH="main"
DB_NAME="laravel_db"
DB_USER="laravel_user"
DB_PASS="laravel_pass"

echo "=== Updating system ==="

# date
# sudo apt install -y ntpdate
# sudo ntpdate pool.ntp.org

# sudo rm -f /var/lib/dpkg/lock-frontend
# sudo rm -f /var/lib/dpkg/lock
# sudo rm -f /var/cache/apt/archives/lock

# sudo dpkg --configure -a

sudo apt update
sudo apt upgrade -qy

echo "=== Installing dependencies ==="
sudo apt install -qy software-properties-common curl git unzip acl


echo "=== Installing PHP 8.2 and extensions ==="
# sudo add-apt-repository -y ppa:ondrej/php
sudo apt update
sudo apt install -y php8.2 php8.2-cli php8.2-fpm php8.2-mysql php8.2-xml php8.2-mbstring php8.2-curl php8.2-zip composer


echo "=== Installing composer ==="
php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
php -r "if (hash_file('sha384', 'composer-setup.php') === 'dac665fdc30fdd8ec78b38b9800061b4150413ff2e3b6f88543c636f7cd84f6db9189d43a81e5503cda447da73c7e5b6') { echo 'Installer verified'.PHP_EOL; } else { echo 'Installer corrupt'.PHP_EOL; unlink('composer-setup.php'); exit(1); }"
php composer-setup.php
php -r "unlink('composer-setup.php');"
sudo mv composer.phar /usr/local/bin/composer


echo "=== Installing Nginx ==="
sudo apt install -y nginx
sudo systemctl enable nginx
sudo systemctl start nginx

echo "=== Installing MariaDB ==="
sudo apt install -qy mariadb-server mariadb-client
sudo systemctl enable mariadb
sudo systemctl start mariadb

# Create database and user
sudo mysql -e "CREATE DATABASE IF NOT EXISTS $DB_NAME;"
sudo mysql -e "CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASS';"
sudo mysql -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';"
sudo mysql -e "FLUSH PRIVILEGES;"

echo "=== Installing Redis ==="
sudo apt install -qy redis-server
sudo systemctl enable redis-server
sudo systemctl start redis-server

echo "=== Deploying Laravel application ==="
if [ ! -d "$APP_DIR" ]; then
    sudo git clone -b $BRANCH $REPO_URL $APP_DIR
fi

cd $APP_DIR
sudo composer install --no-interaction --prefer-dist
sudo cp .env.example .env
sudo php artisan key:generate
# THis part need manual configuration
# sudo php artisan migrate --force

echo "=== Setting permissions ==="
sudo chown -R www-data:www-data $APP_DIR
sudo chmod -R 775 $APP_DIR/storage $APP_DIR/bootstrap/cache

echo "=== Configuring Nginx site ==="
NGINX_CONF="/etc/nginx/sites-available/$APP_NAME"
sudo tee $NGINX_CONF > /dev/null <<EOL
server {
    listen 80;
    server_name _;
    root $APP_DIR/public;

    index index.php index.html;

    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }

    location ~ \.php\$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
    }

    location ~ /\.ht {
        deny all;
    }
}
EOL

sudo ln -sf $NGINX_CONF /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx

echo "=== Deployment completed successfully! ==="
